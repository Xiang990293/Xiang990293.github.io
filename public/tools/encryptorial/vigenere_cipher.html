<head>
    <title>維吉尼亞密碼</title>
    <meta name="description" content="維吉尼亞密碼工具與解說">
</head>
<section id="tool_section">
    <h1>維吉尼亞密碼工具</h1>

    <label for="plaintextInput">輸入文字：</label>
    <textarea id="plaintextInput" rows="3" placeholder="請輸入明文"></textarea>

    <label for="keyInput">密鑰 (只輸入英文字母)：</label>
    <input type="text" id="keyInput" placeholder="如：LEMON" maxlength="20" />

    <div id="buttonGroup">
        <button onclick="vigenereEncrypt()">加密</button>
        <button onclick="vigenereDecrypt()">解密</button>
    </div>

    <label for="outputText">結果：</label>
    <textarea id="outputText" rows="3" readonly></textarea>

    <details>
        <summary>動畫設定</summary>
        <label>
            <input type="checkbox" id="vigenereEnableAnimation" checked />
            啟用動畫效果
        </label>
        <div id="animation-speed-inline">
            <label for="vigenereAnimationSpeed">動畫速度</label>
            <span title="快速">🐇</span>
            <input type="range" id="vigenereAnimationSpeed" min="10" max="500" value="255" />
            <span title="慢速">🐢</span>
        </div>
    </details>
    <!-- 清晰展示狀態的字母格子（可延伸使用） -->
    <div id="vigenere_wheel_grid">
        <!-- JS 程式會根據密鑰長度動態產生多輪替字母行 -->
    </div>

</section>
<section id="explanation">
    <h2>維吉尼亞密碼介紹</h2>
    <p>維吉尼亞密碼是一種利用字母表各字元輪替位移的古老加密技術，依照密鑰每個字元決定每個明文字元的偏移量。</p>
    <p>密鑰重複用於明文，產生不同的加密結果，增加破解難度。</p>
</section>
<script>
    window.addEventListener('DOMContentLoaded', () => {
        createFullVigenereTable();
    })

    // 修正負數位移無限迴圈問題，對shift做mod 26
    function modShift(shift) {
        return ((shift % 26) + 26) % 26;
    }

    function alphabet2orderIndex(char) {
        const isLowerCase = char.charCodeAt(0) >= 97
        return { index: char.charCodeAt(0) - (isLowerCase ? 97 : 65), isLowerCase: isLowerCase };
    }

    // 動畫控制變數
    let vigenereAnimationRunning = false;
    let vigenereAnimationCancelToken = 0;
    async function animateVigenere(text, key, isEncrypt = true) {
        const outputElem = document.getElementById('outputText');
        const enableAnimation = document.getElementById('vigenereEnableAnimation').checked;
        const speed = parseInt(document.getElementById('vigenereAnimationSpeed').value, 10);


        vigenereAnimationCancelToken++;
        const currentToken = vigenereAnimationCancelToken;
        vigenereAnimationRunning = true;

        const letterGrid = document.getElementById('vigenere_wheel_grid');


        let finalResult = '';
        let keyCounter = 0; // 用於輪替密鑰索引
        for (let i = 0; i < text.length; i++) {
            const ch = text[i];
            if (ch.match(/[a-zA-Z]/)) {
                const chIndex = alphabet2orderIndex(ch)
                newCharCode = (chIndex.isLowerCase ? 97 : 65) + modShift(chIndex.index + (isEncrypt ? 1 : -1) * alphabet2orderIndex(key[keyCounter]).index);

                finalResult += String.fromCharCode(newCharCode);

                keyCounter++; // 只英文字符計入
                keyCounter -= keyCounter >= key.length ? key.length : 0;
            } else {
                finalResult += ch;
            }
        }

        // 不啟用動畫直接顯示結果
        if (!enableAnimation) {
            letterGrid.innerHTML = '';
            createFullVigenereTable();
            outputElem.value = finalResult;
            return;
        }
        // 動畫啟用時載入密鑰相關輪替方陣
        if (letterGrid) {
            letterGrid.innerHTML = '';
            createCustomVigenereGridNoDedup(key);
            letterGrid.style.display = 'flex';
        }

        // 動畫啟動
        outputElem.value = '';
        const wait = ms => new Promise(res => setTimeout(res, ms));
        let accumulated = '';
        keyCounter = 0; // 用於輪替密鑰索引
        const table = document.getElementById('vigenere_table_custom');

        for (let i = 0; i < text.length; i++) {
            if (currentToken !== vigenereAnimationCancelToken) {
                vigenereAnimationRunning = false;
                return;
            }

            const ch = text[i];
            if (ch.match(/[a-zA-Z]/)) {
                const chIndex = alphabet2orderIndex(ch);
                highlightCustomVigenereGridNoDedup(table, key[keyCounter], ch, keyCounter);
                const newCharCode = (chIndex.isLowerCase ? 97 : 65) + modShift(chIndex.index + (isEncrypt ? 1 : -1) * alphabet2orderIndex(key[keyCounter]).index);
                accumulated += String.fromCharCode(newCharCode)
                outputElem.value = accumulated;
                keyCounter++; // 只英文字符計入
                keyCounter -= keyCounter >= key.length ? key.length : 0;
            } else {
                accumulated += ch;
                outputElem.value = accumulated;
            }
            await wait(speed);
        }

        vigenereAnimationRunning = false;
    }

    // 維吉尼亞加密觸發
    function vigenereEncrypt() {
        const plaintext = document.getElementById('plaintextInput').value;
        const key = document.getElementById('keyInput').value;
        if (!key.match(/^[a-zA-Z]+$/)) {
            alert('密鑰只能包含英文字母 A-Z');
            return;
        }
        animateVigenere(plaintext, key, true);
    }

    // 維吉尼亞解密觸發
    function vigenereDecrypt() {
        const ciphertext = document.getElementById('plaintextInput').value;
        const key = document.getElementById('keyInput').value;
        if (!key.match(/^[a-zA-Z]+$/)) {
            alert('密鑰只能包含英文字母 A-Z');
            return;
        }
        animateVigenere(ciphertext, key, false);
    }

    // 動畫勾選開關事件，可擴展使用
    function toggleVigenereAnimation() {
        const enableAnimation = document.getElementById('vigenereEnableAnimation').checked;
        const letterGrid = document.getElementById('vigenere_letter_grid');
        if (letterGrid) letterGrid.style.display = enableAnimation ? 'flex' : 'none';
    }

    // 產生輪替字母表的字串，入口為密鑰字元(A-Z)
    function generateShiftedAlphabet(startChar) {
        const baseCode = 65; // A
        const shift = startChar.charCodeAt(0) - baseCode;
        let result = '';
        for (let i = 0; i < 26; i++) {
            const charCode = ((i + shift) % 26) + baseCode;
            result += String.fromCharCode(charCode);
        }
        return result;
    }

    // 生成多行輪替字母表格
    function createCustomVigenereGridNoDedup(key) {
        const container = document.getElementById('vigenere_wheel_grid');
        container.innerHTML = '';

        if (!key) return;

        const upperKey = key.toUpperCase();
        const baseCharCode = 65; // A

        const table = document.createElement('table');
        table.id = 'vigenere_table_custom';
        table.style.borderCollapse = 'collapse';
        table.style.fontFamily = 'monospace';
        table.style.textAlign = 'center';

        // 生成表頭行(橫軸明文字母 A-Z)
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.appendChild(document.createElement('th')); // 左上空白

        for (let i = 0; i < 26; i++) {
            const th = document.createElement('th');
            th.textContent = String.fromCharCode(baseCharCode + i);
            th.style.padding = '4px';
            headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // 生成tbody，每個密鑰字元一行，不去重，按原序列
        const tbody = document.createElement('tbody');
        for (const keyChar of upperKey) {
            // 只產生大寫字母列，其他字元不處理
            if (keyChar < 'A' || keyChar > 'Z') continue;

            const tr = document.createElement('tr');

            const th = document.createElement('th');
            th.textContent = keyChar;
            th.style.padding = '4px';
            tr.appendChild(th);

            const shift = keyChar.charCodeAt(0) - baseCharCode;
            for (let i = 0; i < 26; i++) {
                const td = document.createElement('td');
                td.textContent = String.fromCharCode(((i + shift) % 26) + baseCharCode);
                td.style.padding = '4px';
                td.style.border = '1px solid #ccc';
                tr.appendChild(td);
            }
            tbody.appendChild(tr);
        }

        table.appendChild(tbody);
        container.appendChild(table);
    }

    function createFullVigenereTable() {
        const container = document.getElementById('vigenere_wheel_grid');
        container.innerHTML = '';

        const baseCharCode = 65; // A
        const table = document.createElement('table');
        table.id = 'vigenere_full_table';
        table.style.borderCollapse = 'collapse';
        table.style.fontFamily = 'monospace';
        table.style.textAlign = 'center';

        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        headerRow.appendChild(document.createElement('th')); // 左上空白

        for (let i = 0; i < 26; i++) {
            const th = document.createElement('th');
            th.textContent = String.fromCharCode(baseCharCode + i);
            th.style.padding = '4px';
            headerRow.appendChild(th);
        }
        thead.appendChild(headerRow);
        table.appendChild(thead);

        const tbody = document.createElement('tbody');
        for (let r = 0; r < 26; r++) {
            const tr = document.createElement('tr');
            const keyChar = String.fromCharCode(baseCharCode + r);
            const th = document.createElement('th');
            th.textContent = keyChar;
            th.style.padding = '4px';
            tr.appendChild(th);

            for (let c = 0; c < 26; c++) {
                const td = document.createElement('td');
                td.textContent = String.fromCharCode(((c + r) % 26) + baseCharCode);
                td.style.padding = '4px';
                td.style.border = '1px solid #ccc';
                tr.appendChild(td);
            }

            tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        container.appendChild(table);
    }


    // currentKeyIndex 是動畫中正在使用的密鑰字元索引
    function highlightCustomVigenereGridNoDedup(tableElem, keyChar, textChar, currentKeyIndex) {
        if (!tableElem) return;

        // 清除所有高亮
        tableElem.querySelectorAll('tr, td, th').forEach(cell => {
            cell.classList.remove('highlight-row', 'highlight-column', 'highlight-cell');
        });

        const isUpper = (textChar.charCodeAt(0) >= 65 && textChar.charCodeAt(0) <= 90);
        const baseCode = isUpper ? 65 : 97;

        // 這裡不用 findIndex 直接使用 currentKeyIndex
        const rows = [...tableElem.tBodies[0].rows];
        if (currentKeyIndex < 0 || currentKeyIndex >= rows.length) return;

        const row = rows[currentKeyIndex];
        const colIndex = textChar.charCodeAt(0) - baseCode + 1;

        // 標示目前橫列
        row.classList.add('highlight-row');

        // 標示表頭欄（橫軸首行th）
        tableElem.tHead.querySelectorAll("th")[colIndex].classList.add('highlight-column');

        // **標示該直排所有格子**
        for (let i = 0; i < rows.length; i++) {
            // 純格 (第一格是th)
            if (rows[i].cells[colIndex]) rows[i].cells[colIndex].classList.add('highlight-column');
        }

        // 標示交集
        const cell = row.cells[colIndex];
        if (cell) cell.classList.add('highlight-cell');
    }

</script>
<style>
    /* 工具區背景統一 */
    #tool_section {
        background-color: #c6f2ffd2;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 20px;
        display: flex;
        flex-direction: column;
        /* 讓區塊上下排列 */
        gap: 20px;
    }

    /* 輸入框和結果框 */
    textarea,
    input[type="text"] {
        width: 100%;
        font-size: 1rem;
        padding: 8px;
        border-radius: 5px;
        /* 與凱薩密碼統一 */
        border: 1px solid #b0c4de;
        resize: vertical;
        box-sizing: border-box;
        transition: border-color 0.3s ease;
        color: #222;
        font-family: monospace;
    }

    textarea:focus,
    input[type="text"]:focus {
        border-color: #3ca7d8;
        /* 凱薩藍 */
        outline: none;
        box-shadow: 0 0 8px #7ec4ff88;
    }

    /* 按鈕置中與間距 */
    #buttonGroup {
        margin-top: 10px;
        display: flex;
        gap: 10px;
    }

    /* 按鈕 */
    #buttonGroup button {
        flex: 1;
        padding: 10px 15px;
        font-size: 1rem;
        background-color: #3ca7d8;
        /* 按鈕藍 */
        color: white;
        border: none;
        border-radius: 5px;
        /* 與凱薩一致 */
        cursor: pointer;
        transition: background-color 0.25s ease;
    }

    #buttonGroup button:hover {
        background-color: #2a7bb7;
    }

    /* 折疊面板 */
    details {
        border: 1px solid #b0c4de;
        border-radius: 5px;
        padding: 10px 15px;
        background-color: #e6f0ff;
        color: #004080;
    }

    summary {
        font-weight: bold;
        cursor: pointer;

    }

    /* 動畫速度區 */
    #animation-speed-inline {
        display: flex;
        align-items: center;
        gap: 8px;
        width: fit-content;
    }

    #animation-speed-inline span {
        font-size: 20px;
        filter: grayscale(100%) brightness(0) saturate(100%);

    }

    /* 字母格子 */
    #wheel_grid,
    #vigenere_wheel_grid {
        font-family: monospace;
        display: flex;
        flex-direction: column;
        gap: 6px;
        margin-top: 10px;
    }

    .wheel-row {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

    .wheel-row .letter-cell {
        width: 22px;
        height: 26px;
        border: 1px solid #ccc;
        border-radius: 4px;
        text-align: center;
        line-height: 26px;
        transition: background-color 0.3s ease;
        font-weight: normal;
        cursor: default;
    }

    /* 高亮當前輪替字母行的整列背景柔和色 */
    .wheel-row.active-row {
        background-color: #eef6ff;
        border-radius: 6px;
        padding: 3px 0;
    }

    /* 三類字元高亮色調 */
    .wheel-row .letter-cell.active-original {
        background-color: #ffa67d;
        /* 橘 */
        color: #3b1f00;
        font-weight: bold;
    }

    .wheel-row .letter-cell.active-current {
        background-color: #f7d87a;
        /* 黃 */
        color: #4a3d00;
        font-weight: bold;
    }

    .wheel-row .letter-cell.active-final {
        background-color: #a0f7a4;
        /* 綠 */
        color: #004d09;
        font-weight: bold;
    }


    .letter-row {
        display: flex;
        gap: 4px;
        justify-content: center;
    }

    .letter-cell {
        width: 22px;
        height: 26px;
        border: 1px solid #ccc;
        border-radius: 5px;
        line-height: 26px;
        text-align: center;
        transition: background-color 0.3s ease;
        font-weight: 600;
        color: #003366;
    }

    /* 色彩配合凱薩密碼 */
    .highlight-row {
        background-color: #f0f7ff;
    }

    .highlight-column {
        background-color: #f0f7ff;
    }

    .highlight-cell {
        background-color: #a0f7a4;
        font-weight: bold;
    }


    /* 說明區 */
    section#explanation {
        background-color: #e6f0ff;
        padding: 15px;
        border-radius: 5px;
    }

    /* 響應式調整 */
    @media (max-width: 480px) {
        .letter-cell {
            width: 18px;
            height: 20px;
            font-size: 0.9rem;
        }
    }
</style>