<head>
    <title>速度計算器</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="SHA512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="icon" href="/favicon.png" />
</head>
<div class="input-container">
    <label for="distance">參照物間隔: </label>
    <input type="number" id="distance" placeholder="輸入距離">
    <span>公尺</span>
    <span class="info-icon" onclick="toggleInfo()">
        <i class="fas fa-info-circle" style="color: blue;"></i>
    </span>
    <div class="info-text">
        你所乘坐的交通工具的窗外，是否有反覆出現的相同物體？
        如地鐵燈號、路上虛線標線、電線杆、公里數指示牌等，只要這些標誌固定距離不斷出現，就能透過此計算機手動計算目前的平均速度。
        <div style="color: red;">* 請在輸入框中輸入兩相同參照物間的距離，單位公尺</div>
        <div style="color: #00a1a1;">點擊圖標<i class="fas fa-info-circle" style="color: blue;"></i>關閉本提示</div>
    </div>
</div>
<span>單位: </span>
<select id="distanceUnit" title="距離單位">
    <option value=100>公分</option>
    <option value=1>公尺</option>
    <option value=0.001 selected>公里</option>
</select>
<span>/</span>
<select id="timeUnit" title="時間單位">
    <option value=1>秒</option>
    <option value=60>分</option>
    <option value=3600 selected>小時</option>
</select>

<button id="startButton">開始</button>
<div id="result">結果將顯示於此</div>

<div id="chart">
    <canvas id="speedChart" width="400" height="200"></canvas>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    const distanceInput = document.getElementById('distance');
    const distanceUnitSelect = document.getElementById('distanceUnit');
    const timeUnitSelect = document.getElementById('timeUnit');
    const startButton = document.getElementById('startButton');
    const resultDiv = document.getElementById('result');
    const ctx = document.getElementById('speedChart').getContext('2d');

    let previousTime = null;
    let previousSpeed = null;
    let results = [];
    let startTime = null;

    // 初始化圖表
    const speedChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [], // 時間標籤
            datasets: [{
                label: '速度 (公尺/秒)',
                data: [], // 速度數據
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 2,
                fill: false,
            }]
        },
        options: {
            scales: {
                x: {
                    title: {
                        display: true,
                        text: '時間 (秒)'
                    }
                },
                y: {
                    title: {
                        display: true,
                        text: '速度 (公尺/秒)'
                    }
                }
            }
        }
    });

    // 當距離單位改變時清空結果並重置
    distanceUnitSelect.addEventListener('change', resetCalculator);

    // 當時間單位改變時清空結果並重置
    timeUnitSelect.addEventListener('change', resetCalculator);

    function resetCalculator() {
        resultDiv.textContent = ''; // 清空結果
        results = []; // 重置結果陣列
        previousTime = null; // 重置之前的時間
        previousSpeed = null; // 重置之前的速度
        startTime = null;
        speedChart.data.labels = []; // 清空圖表標籤
        speedChart.data.datasets[0].data = []; // 清空圖表數據
        speedChart.update(); // 更新圖表
    }

    startButton.addEventListener('click', () => {
        const distance = parseFloat(distanceInput.value);
        const distanceUnit = distanceUnitSelect.value; // 取得距離單位
        const timeUnit = timeUnitSelect.value; // 取得速度單位

        if (isNaN(distance)) {
            resultDiv.textContent = '請輸入有效數字';
            return;
        }

        const currentTime = Date.now();

        if (previousTime) {
            const elapsedTime = (currentTime - previousTime) / 1000; // 秒

            let speed = distance * distanceUnit * timeUnit / elapsedTime; // 公尺/秒

            results.push({ speed, totalTime: currentTime - startTime }); // 將速度和經過的時間儲存為物件

            // 只保留最近五次的結果
            if (results.length > 5) {
                results.shift();
            }

            const distanceUnitOptions = distanceUnitSelect.options;
            const timeUnitOptions = timeUnitSelect.options;
            const distanceUnitText = distanceUnitOptions[distanceUnitSelect.selectedIndex].text;
            const timeUnitText = timeUnitOptions[timeUnitSelect.selectedIndex].text;

            let speedDiffText = '';
            if (previousSpeed !== null) {
                const speedDiff = speed - previousSpeed;
                speedDiffText = `(較上次紀錄${speedDiff > 0 ? '快' : '慢'}${Math.abs(speedDiff).toFixed(2)} ${distanceUnitText}/${timeUnitText})`;
            }

            // 計算平均速度
            const averageSpeed = results.reduce((total, record) => total + record.speed, 0) / results.length;

            // 顯示結果
            let resultText = `本次速度: ${speed.toFixed(2)} ${distanceUnitText}/${timeUnitText} ${speedDiffText}<br>`;
            resultText += `最近五次紀錄:<br>`;

            // 顯示所有最近紀錄
            results.forEach((record, index) => {
                const totalTimeInSeconds = record.totalTime / 1000;
                resultText += `第${index + 1}次紀錄: 速度: ${record.speed.toFixed(2)} ${distanceUnitText}/${timeUnitText}，總時間: ${totalTimeInSeconds.toFixed(2)} 秒<br>`;
            });

            resultText += `最近五次平均速度: ${averageSpeed.toFixed(2)} ${distanceUnitText}/${timeUnitText}`;

            resultDiv.innerHTML = resultText;

            previousSpeed = speed; // 保存當前速度

            // 更新圖表數據
            speedChart.data.labels.push((currentTime - startTime) / 1000); // 將經過的時間（秒）作為標籤
            speedChart.data.datasets[0].data.push(speed); // 將當前速度添加到數據中
            speedChart.update(); // 更新圖表
        } else {
            startTime = currentTime;
            resultDiv.textContent = '再次點擊開始紀錄';

            // 初始化圖表數據
            speedChart.data.labels.push(0); // 初始時間為 0
            speedChart.data.datasets[0].data.push(0); // 初始速度為 0
            speedChart.update();
        }

        previousTime = currentTime;

        if (!startTime) {
            startTime = currentTime; // 初始化開始時間
        }

    });

    function toggleInfo() {
        var infoText = document.querySelector('.info-text');
        infoText.style.display = (infoText.style.display === 'none') ? 'block' : 'none';
    }


</script>
<style>
    #distance {
        padding: 8px;
        margin-bottom: 10px;
    }

    select {
        padding: 8px;
        margin-bottom: 10px;
    }

    button {
        padding: 10px 20px;
        background-color: #007bff;
        color: white;
        border: none;
        cursor: pointer;
    }

    button:hover {
        background-color: #0056b3;
    }

    #result {
        margin-top: 20px;
        font-weight: bold;
    }

    .input-container {
        display: flex;
        align-items: center;
        position: relative;
        /* 設定為相對定位，以便將 info-icon 絕對定位 */
    }

    .input-container input {
        margin-right: 5px;
    }

    .info-icon {
        cursor: pointer;
        margin-left: 5px;
        color: #007bff;
        /* 設定圖示顏色 */
    }

    .info-text {
        position: absolute;
        top: 100%;
        /* 放置在 input-container 的下方 */
        left: 0;
        background-color: #f9f9f9;
        border: 1px solid #ccc;
        padding: 10px;
        margin-top: 5px;
        width: 250px;
        /* 設定說明文字的寬度 */
        display: block;
        /* 預設顯示 */
        z-index: 1;
        /* 確保它位於其他元素之上 */
    }
</style>